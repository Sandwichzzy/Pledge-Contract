# Pledge Solidity 部署和测试指南

## 📋 部署概述

本项目采用分阶段部署策略，确保合约间的依赖关系正确建立。部署顺序如下：

1. **多签名合约** (multiSignature)
2. **债务代币合约** (spDebtToken, jpDebtToken)
3. **模拟合约** (仅本地环境)
4. **价格预言机** (BscPledgeOracle,MockOracle)
5. **主质押池** (PledgePool)

## 🌐 支持的网络环境

### 1. Hardhat 本地网络 (localhost)

- **用途**: 本地开发和测试
- **SwapRouter**: 使用 MockUniswapV2Router 合约
- **代币**: 使用模拟的 ERC20 代币 (MockUSDT, MockBTC, MockUSDC)
- **预言机**: 支持手动价格设置(MockOracle)

### 2. Sepolia 测试网

- **用途**: 公共测试网测试
- **SwapRouter**: 使用 Uniswap V2 官方路由器 (0xeE567Fe1712Faf6149d80dA1E6934E354124CfE3)
- **代币**: 使用 Sepolia 测试网上的真实代币
- **预言机**: 支持 Chainlink 价格聚合器

### 3. BSC 测试网

- **用途**: BSC 链测试
- **SwapRouter**: 使用 PancakeSwap 路由器 (0xD99D1c33F9fC3444f8101754aBC46c52416550D1)
- **代币**: 使用 BSC 测试网上的真实代币
- **预言机**: 支持 Chainlink 价格聚合器

## 🚀 部署步骤

### 准备工作

1. **安装依赖**

```bash
npm install
```

2. **配置环境变量**
   创建 `.env` 文件并配置：

```env
# BSC测试网
BSC_TESTNET_URL=https://data-seed-prebsc-1-s1.binance.org:8545/
PRIVATE_KEY=your_private_key
PRIVATE_KEY_2=your_private_key_2
PRIVATE_KEY_3=your_private_key_3

# Sepolia测试网
SEPOLIA_URL=https://sepolia.infura.io/v3/your_project_id
ETHERSCAN_API_KEY=your_etherscan_api_key
```

### 本地部署 (Hardhat)

1. **启动本地节点**

```bash
npx hardhat node
```

2. **执行完整部署**

```bash
# 部署所有合约（包括模拟合约）
npx hardhat deploy --network localhost

# 或者分步骤部署
npx hardhat deploy --tags multiSignature --network localhost
npx hardhat deploy --tags spDebtToken,jpDebtToken --network localhost
npx hardhat deploy --tags mockContracts --network localhost
npx hardhat deploy --tags BscPledgeOracle --network localhost
npx hardhat deploy --tags PledgePool --network localhost
```

### Sepolia 测试网部署

```bash
# 完整部署（跳过模拟合约）
npx hardhat deploy --network sepolia

# 分步骤部署
npx hardhat deploy --tags multiSignature --network sepolia
npx hardhat deploy --tags spDebtToken,jpDebtToken --network sepolia
npx hardhat deploy --tags BscPledgeOracle --network sepolia
npx hardhat deploy --tags PledgePool --network sepolia
```

### BSC 测试网部署

```bash
# 完整部署
npx hardhat deploy --network bscTestnet

# 分步骤部署
npx hardhat deploy --tags multiSignature --network bscTestnet
npx hardhat deploy --tags spDebtToken,jpDebtToken --network bscTestnet
npx hardhat deploy --tags BscPledgeOracle --network bscTestnet
npx hardhat deploy --tags PledgePool --network bscTestnet
```

## 📊 部署后验证

### 查看部署地址

```bash
# 查看所有部署的合约地址
npx hardhat deployments --network localhost

# 查看特定合约地址
npx hardhat deployments --export-all deployed-contracts.json
```

### 验证合约功能

1. **多签名验证**

```bash
npx hardhat console --network localhost
```

```javascript
const multiSig = await ethers.getContract("multiSignature");
console.log("Owners:", await multiSig.getOwners());
console.log("Threshold:", await multiSig.getThreshold());
```

2. **代币合约验证**

```javascript
const spToken = await ethers.getContract("spDebtToken");
const jpToken = await ethers.getContract("jpDebtToken");
console.log("SP Token:", await spToken.name());
console.log("JP Token:", await jpToken.name());
```

3. **预言机验证**

```javascript
const oracle = await ethers.getContract("BscPledgeOracle");
console.log("Oracle Address:", oracle.address);
```

4. **主合约验证**

```javascript
const pledgePool = await ethers.getContract("PledgePool");
console.log("Pool Length:", await pledgePool.PoolLength());
console.log("Oracle:", await pledgePool.oracle());
console.log("SwapRouter:", await pledgePool.swapRouter());
```

## 🧪 测试指南

### 单元测试

```bash
# 运行所有测试
npx hardhat test

# 运行特定测试文件
npx hardhat test test/PledgePool.test.js

# 显示 Gas 报告
REPORT_GAS=true npx hardhat test

# 测试覆盖率
npx hardhat coverage
```

### 集成测试

1. **创建测试池**

```javascript
// 在 hardhat console 中
const pledgePool = await ethers.getContract("PledgePool");
const spToken = await ethers.getContract("spDebtToken");
const jpToken = await ethers.getContract("jpDebtToken");

// 获取测试代币地址
const mockUSDT = await ethers.getContract("MockUSDT");
const mockBTC = await ethers.getContract("MockBTC");

// 创建测试池
const settleTime = Math.floor(Date.now() / 1000) + 3600; // 1小时后
const endTime = settleTime + 86400 * 30; // 30天期限
const interestRate = 10000000; // 10% 年利率 (1e8基础)
const maxSupply = ethers.utils.parseUnits("1000000", 6); // 100万USDT
const martgageRate = 150000000; // 150% 抵押率

await pledgePool.createPool(
  settleTime,
  endTime,
  interestRate,
  maxSupply,
  martgageRate,
  mockUSDT.address, // 借出代币
  mockBTC.address, // 抵押代币
  spToken.address, // SP代币
  jpToken.address, // JP代币
  120000000 // 120% 清算阈值
);
```

2. **测试用户操作**

```javascript
// 获取测试代币
await mockUSDT.faucet(ethers.utils.parseUnits("10000", 6)); // 获取10000 USDT
await mockBTC.faucet(ethers.utils.parseUnits("1", 8)); // 获取1 BTC

// 授权合约使用代币
await mockUSDT.approve(pledgePool.address, ethers.constants.MaxUint256);
await mockBTC.approve(pledgePool.address, ethers.constants.MaxUint256);

// 出借操作
await pledgePool.depositLend(0, ethers.utils.parseUnits("1000", 6)); // 存入1000 USDT

// 借款操作
await pledgePool.depositBorrow(0, ethers.utils.parseUnits("0.1", 8)); // 质押0.1 BTC
```

## 🔧 故障排除

### 常见问题

1. **部署失败: "已存在合约"**

```bash
# 清理部署缓存
rm -rf deployments/localhost
npx hardhat deploy --network localhost
```

2. **Gas 估算失败**

```bash
# 增加 gas limit
npx hardhat deploy --network localhost --gas-limit 8000000
```

3. **网络连接超时**

- 检查网络配置
- 增加超时时间设置
- 检查私钥配置

4. **依赖合约未找到**

- 确保按正确顺序部署
- 检查依赖标签配置
- 重新部署依赖合约

### 调试工具

1. **查看交易详情**

```bash
npx hardhat verify --network sepolia DEPLOYED_CONTRACT_ADDRESS "constructor_arg1" "constructor_arg2"
```

2. **合约交互调试**

```bash
npx hardhat console --network localhost
```

3. **事件监听**

```javascript
// 监听合约事件
pledgePool.on("DepositLend", (from, token, amount, mintAmount) => {
  console.log("Deposit:", {
    from,
    token,
    amount: amount.toString(),
    mintAmount: mintAmount.toString(),
  });
});
```

## 📝 部署检查清单

- [ ] 环境变量配置完成
- [ ] 网络配置正确
- [ ] 私钥和地址配置
- [ ] 多签名地址配置
- [ ] 合约按顺序部署成功
- [ ] 合约地址记录保存
- [ ] 基本功能验证通过
- [ ] 权限设置确认
- [ ] 测试用例运行通过

## 🎯 后续配置

部署完成后，需要进行以下配置：

1. **设置价格聚合器** (生产环境)
2. **配置多签名权限**
3. **设置手续费参数**
4. **初始化测试池**
5. **权限管理设置**

---

**注意**: 在生产环境部署前，请确保完成充分的测试和安全审计。
